#!/usr/bin/env python3\n\"\"\"\nFastAPI Router for Office Document Conversion\nSupports upload and conversion of DOCX, XLSX, PPTX to various formats\nMPP-XML Converter Pro - Enterprise Edition\n\"\"\"\n\nimport os\nimport tempfile\nimport logging\nfrom pathlib import Path\nfrom typing import List, Optional\nfrom uuid import uuid4\nimport time\nimport magic\n\n# FastAPI imports\nfrom fastapi import APIRouter, UploadFile, File, Form, HTTPException, Depends, BackgroundTasks\nfrom fastapi.responses import JSONResponse\nfrom pydantic import BaseModel, Field\n\n# Local imports (adjust based on your structure)\nfrom app.converters.office import (\n    OfficeConverter, \n    OfficeConverterError, \n    SUPPORTED_FORMATS,\n    validate_office_format,\n    get_conversion_price\n)\nfrom app.tasks import convert_office_task\n# from app.db import create_order, get_user_by_token\n# from app.storage import upload_to_minio\n# from app.auth import get_current_user\n\nlog = logging.getLogger(\"routers.office\")\n\n# Create router\nrouter = APIRouter(\n    prefix=\"/convert\",\n    tags=[\"office-conversion\"],\n    responses={404: {\"description\": \"Not found\"}}\n)\n\n# Pydantic models\nclass ConversionRequest(BaseModel):\n    \"\"\"Request model for office conversion\"\"\"\n    target_format: str = Field(..., description=\"Target format (pdf, docx, xlsx, etc)\")\n    quality: Optional[str] = Field(\"high\", description=\"Conversion quality: low, medium, high\")\n    timeout: Optional[int] = Field(300, description=\"Conversion timeout in seconds\")\n    webhook_url: Optional[str] = Field(None, description=\"Webhook URL for completion notification\")\n\nclass ConversionResponse(BaseModel):\n    \"\"\"Response model for office conversion\"\"\"\n    success: bool\n    order_id: str\n    status: str\n    message: str\n    price_brl: float\n    estimated_time: Optional[int] = None\n    download_url: Optional[str] = None\n    error: Optional[str] = None\n\nclass SupportedFormatsResponse(BaseModel):\n    \"\"\"Response model for supported formats\"\"\"\n    input_formats: List[str]\n    output_formats: List[str] \n    popular_conversions: List[dict]\n    total_conversions: int\n\n# Constants\nMAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB\nALLOWED_MIME_TYPES = {\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  # DOCX\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',       # XLSX\n    'application/vnd.openxmlformats-officedocument.presentationml.presentation', # PPTX\n    'application/msword',  # DOC\n    'application/vnd.ms-excel',  # XLS\n    'application/vnd.ms-powerpoint',  # PPT\n    'application/vnd.oasis.opendocument.text',  # ODT\n    'application/vnd.oasis.opendocument.spreadsheet',  # ODS\n    'text/csv',  # CSV\n    'application/rtf',  # RTF\n}\n\n# Dependency functions\ndef validate_file_upload(file: UploadFile) -> bool:\n    \"\"\"Validate uploaded file\"\"\"\n    # Check file size\n    if hasattr(file, 'size') and file.size > MAX_FILE_SIZE:\n        raise HTTPException(\n            status_code=413, \n            detail=f\"Arquivo excede limite de {MAX_FILE_SIZE//1024//1024}MB\"\n        )\n    \n    # Check file extension\n    if not validate_office_format(file.filename):\n        raise HTTPException(\n            status_code=400,\n            detail=\"Formato de arquivo n√£o suportado. Use: DOCX, XLSX, PPTX, DOC, XLS, PPT, ODT, ODS, CSV\"\n        )\n    \n    return True\n\ndef validate_conversion_params(target_format: str, input_filename: str) -> dict:\n    \"\"\"Validate conversion parameters\"\"\"\n    # Normalize formats\n    target_format = target_format.lower().lstrip('.')\n    input_ext = Path(input_filename).suffix.lstrip('.').lower()\n    \n    # Check if target format is supported\n    if target_format not in SUPPORTED_FORMATS['output']:\n        raise HTTPException(\n            status_code=400,\n            detail=f\"Formato de sa√≠da '{target_format}' n√£o suportado. Use: {', '.join(SUPPORTED_FORMATS['output'])}\"\n        )\n    \n    # Get conversion info and pricing\n    try:\n        converter = OfficeConverter()\n        conversion_info = converter.validate_conversion(input_ext, target_format)\n        return {\n            'input_format': input_ext,\n            'output_format': target_format,\n            'price': conversion_info['price'],\n            'complexity': conversion_info['complexity']\n        }\n    except OfficeConverterError as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# Router endpoints\n@router.get(\"/office/formats\", response_model=SupportedFormatsResponse)\nasync def get_supported_formats():\n    \"\"\"Get list of supported input/output formats and popular conversions\"\"\"\n    try:\n        converter = OfficeConverter()\n        conversions = converter.get_supported_conversions()\n        \n        # Get popular conversions (low complexity, common formats)\n        popular = [c for c in conversions if c['complexity'] == 'low'][:10]\n        \n        return SupportedFormatsResponse(\n            input_formats=sorted(list(SUPPORTED_FORMATS['input'])),\n            output_formats=sorted(list(SUPPORTED_FORMATS['output'])),\n            popular_conversions=popular,\n            total_conversions=len(conversions)\n        )\n    except Exception as e:\n        log.exception(\"Error getting supported formats\")\n        raise HTTPException(status_code=500, detail=\"Erro interno do servidor\")\n\n@router.post(\"/office/quote\")\nasync def get_conversion_quote(\n    filename: str = Form(...),\n    target_format: str = Form(...)\n):\n    \"\"\"Get pricing quote for office document conversion\"\"\"\n    try:\n        # Validate conversion\n        conversion_info = validate_conversion_params(target_format, filename)\n        \n        return {\n            \"success\": True,\n            \"conversion\": {\n                \"from\": conversion_info['input_format'].upper(),\n                \"to\": conversion_info['output_format'].upper(),\n                \"price_brl\": conversion_info['price'],\n                \"complexity\": conversion_info['complexity'],\n                \"estimated_time_seconds\": {\n                    'low': 30,\n                    'medium': 120, \n                    'high': 300\n                }[conversion_info['complexity']]\n            }\n        }\n    except HTTPException:\n        raise\n    except Exception as e:\n        log.exception(\"Error generating quote\")\n        raise HTTPException(status_code=500, detail=\"Erro ao gerar or√ßamento\")\n\n@router.post(\"/office\", response_model=ConversionResponse)\nasync def upload_and_convert_office(\n    background_tasks: BackgroundTasks,\n    file: UploadFile = File(...),\n    target_format: str = Form(...),\n    quality: str = Form(\"high\"),\n    timeout: int = Form(300),\n    webhook_url: Optional[str] = Form(None)\n    # current_user = Depends(get_current_user)  # Uncomment when auth is ready\n):\n    \"\"\"Upload and convert office document\"\"\"\n    \n    start_time = time.time()\n    order_id = uuid4().hex\n    temp_file = None\n    \n    log.info(f\"üöÄ Office conversion request: {file.filename} ‚Üí {target_format}\")\n    \n    try:\n        # Validate file upload\n        validate_file_upload(file)\n        \n        # Validate conversion parameters\n        conversion_info = validate_conversion_params(target_format, file.filename)\n        \n        # Save uploaded file temporarily\n        input_ext = conversion_info['input_format']\n        temp_file = f\"/tmp/office_upload_{order_id}.{input_ext}\"\n        \n        # Write file with size control\n        total_size = 0\n        with open(temp_file, \"wb\") as buffer:\n            while True:\n                chunk = await file.read(1024 * 1024)  # 1MB chunks\n                if not chunk:\n                    break\n                \n                total_size += len(chunk)\n                if total_size > MAX_FILE_SIZE:\n                    buffer.close()\n                    os.remove(temp_file)\n                    raise HTTPException(\n                        status_code=413, \n                        detail=f\"Arquivo excede limite de {MAX_FILE_SIZE//1024//1024}MB\"\n                    )\n                \n                buffer.write(chunk)\n        \n        # Verify file type using magic\n        try:\n            file_type = magic.from_file(temp_file, mime=True)\n            if file_type not in ALLOWED_MIME_TYPES:\n                log.warning(f\"Suspicious file type: {file_type} for {file.filename}\")\n                # Continue but log for security monitoring\n        except Exception:\n            # Magic not available, continue with extension-based validation\n            pass\n        \n        # Upload to storage (MinIO)\n        object_name = f\"uploads/{order_id}/{file.filename}\"\n        \n        # TODO: Implement your storage upload\n        # upload_to_minio(temp_file, object_name)\n        \n        # Create order in database\n        # order = create_order(\n        #     order_id=order_id,\n        #     user_id=current_user.id,\n        #     input_file=object_name,\n        #     target_format=conversion_info['output_format'],\n        #     price_brl=conversion_info['price'],\n        #     status=\"PENDING_PAYMENT\"\n        # )\n        \n        # For demo: skip payment and start conversion immediately\n        # In production: wait for payment confirmation before queuing\n        \n        # Queue conversion task\n        task_options = {\n            'timeout': min(timeout, 600),  # Max 10 minutes\n            'quality': quality,\n            'webhook_url': webhook_url\n        }\n        \n        conversion_task = convert_office_task.delay(\n            order_id=order_id,\n            object_name=object_name,\n            target_format=conversion_info['output_format'],\n            **task_options\n        )\n        \n        upload_time = time.time() - start_time\n        \n        log.info(f\"‚úÖ Order created: {order_id}, Task: {conversion_task.id} ({upload_time:.2f}s)\")\n        \n        return ConversionResponse(\n            success=True,\n            order_id=order_id,\n            status=\"QUEUED\",\n            message=f\"Convers√£o {conversion_info['input_format'].upper()}‚Üí{conversion_info['output_format'].upper()} iniciada\",\n            price_brl=conversion_info['price'],\n            estimated_time={\n                'low': 30,\n                'medium': 120,\n                'high': 300\n            }[conversion_info['complexity']]\n        )\n        \n    except HTTPException:\n        # Re-raise HTTP exceptions\n        raise\n    except Exception as e:\n        log.exception(f\"Unexpected error in office conversion: {order_id}\")\n        raise HTTPException(\n            status_code=500, \n            detail=\"Erro interno do servidor durante convers√£o\"\n        )\n    finally:\n        # Cleanup temporary file\n        if temp_file and os.path.exists(temp_file):\n            try:\n                os.remove(temp_file)\n            except Exception:\n                pass\n\n@router.get(\"/office/status/{order_id}\")\nasync def get_conversion_status(order_id: str):\n    \"\"\"Get status of office document conversion\"\"\"\n    try:\n        # TODO: Implement your database query\n        # order = get_order_by_id(order_id)\n        # if not order:\n        #     raise HTTPException(status_code=404, detail=\"Pedido n√£o encontrado\")\n        \n        # For demo, return a placeholder response\n        return {\n            \"success\": True,\n            \"order_id\": order_id,\n            \"status\": \"PROCESSING\",\n            \"progress\": 75,\n            \"message\": \"Convertendo documento...\",\n            \"estimated_completion\": \"2-3 minutos\"\n        }\n        \n    except HTTPException:\n        raise\n    except Exception as e:\n        log.exception(f\"Error getting conversion status: {order_id}\")\n        raise HTTPException(status_code=500, detail=\"Erro ao consultar status\")\n\n@router.post(\"/office/batch\")\nasync def batch_convert_office(\n    files: List[UploadFile] = File(...),\n    target_format: str = Form(...),\n    # current_user = Depends(get_current_user)\n):\n    \"\"\"Convert multiple office documents in batch\"\"\"\n    \n    if len(files) > 50:  # Limit batch size\n        raise HTTPException(\n            status_code=400, \n            detail=\"M√°ximo 50 arquivos por lote\"\n        )\n    \n    batch_id = uuid4().hex\n    order_ids = []\n    \n    log.info(f\"üöÄ Batch conversion: {len(files)} files to {target_format}\")\n    \n    try:\n        for i, file in enumerate(files):\n            try:\n                # Validate each file\n                validate_file_upload(file)\n                validate_conversion_params(target_format, file.filename)\n                \n                # Create order for each file (simplified)\n                order_id = f\"{batch_id}_{i:03d}\"\n                order_ids.append(order_id)\n                \n                # TODO: Implement batch processing\n                # Process files and queue conversions\n                \n            except Exception as e:\n                log.error(f\"Failed to process file {file.filename}: {e}\")\n                continue\n        \n        # Queue batch conversion task\n        # batch_task = batch_convert_office_task.delay(order_ids, target_format)\n        \n        return {\n            \"success\": True,\n            \"batch_id\": batch_id,\n            \"total_files\": len(files),\n            \"queued_files\": len(order_ids),\n            \"order_ids\": order_ids,\n            \"status\": \"QUEUED\",\n            \"message\": f\"Lote de {len(order_ids)} convers√µes iniciado\"\n        }\n        \n    except Exception as e:\n        log.exception(f\"Batch conversion error: {batch_id}\")\n        raise HTTPException(\n            status_code=500,\n            detail=\"Erro no processamento em lote\"\n        )\n\n@router.get(\"/office/health\")\nasync def office_converter_health():\n    \"\"\"Health check for office converter\"\"\"\n    try:\n        converter = OfficeConverter()\n        \n        return {\n            \"status\": \"healthy\",\n            \"libreoffice_available\": converter.check_libreoffice_available(),\n            \"supported_conversions\": len(converter.get_supported_conversions()),\n            \"max_file_size_mb\": MAX_FILE_SIZE // 1024 // 1024,\n            \"allowed_formats\": {\n                \"input\": sorted(list(SUPPORTED_FORMATS['input'])),\n                \"output\": sorted(list(SUPPORTED_FORMATS['output']))\n            },\n            \"timestamp\": time.time()\n        }\n    except Exception as e:\n        log.exception(\"Office converter health check failed\")\n        return {\n            \"status\": \"unhealthy\", \n            \"error\": str(e),\n            \"timestamp\": time.time()\n        }\n\nif __name__ == \"__main__\":\n    # Test the router\n    print(\"üöÄ Office Conversion Router Ready!\")\n    print(f\"üìÅ Supported input formats: {len(SUPPORTED_FORMATS['input'])}\")\n    print(f\"üìÑ Supported output formats: {len(SUPPORTED_FORMATS['output'])}\")\n    print(f\"üí∞ Conversion pricing: R$3.00 - R$8.00\")\n