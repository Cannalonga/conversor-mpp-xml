// Prisma Schema for CannaConverter Authentication
// Database: SQLite (easy setup, zero config, CI friendly)

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User model for authentication
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  name                   String?
  password               String?   // Hashed with bcrypt
  accountBlockedForRefund Boolean  @default(false)  // True if user overused refunded credits
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  
  // Relations
  sessions           Session[]
  accounts           Account[]
  credits            UserCredits?
  creditTransactions CreditTransaction[]
  refundRequests     RefundRequest[]
  refundRecoveries   RefundRecovery[]
}

// Session model for NextAuth (optional - using JWT, but good for future)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Account model for OAuth providers (future: Google, GitHub)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Verification token for email verification (future)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CREDITS SYSTEM (CannaCredits)
// ============================================

// User's credit balance
model UserCredits {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Credit transaction history
model CreditTransaction {
  id            String                @id @default(cuid())
  userId        String
  amount        Int                   // positive = purchase, negative = usage
  type          String                // "PURCHASE" | "CONVERSION" | "REFUND" | "BONUS"
  description   String
  metadata      String?               // JSON string for extra data
  jobId         String?               // Link to Job if type is CONVERSION
  stripeEventId String?               // Link to StripeEvent if type is PURCHASE/REFUND
  refunded      Boolean               @default(false) // Whether this transaction was refunded
  createdAt     DateTime              @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([jobId])
  @@index([stripeEventId])
}

// ============================================
// JOB QUEUE SYSTEM
// ============================================

// Conversion Job tracking
model Job {
  id          String    @id @default(cuid())
  userId      String
  converterId String    // e.g., "mpp-to-xml"
  status      String    @default("queued")  // queued | processing | completed | failed
  progress    Int       @default(0)         // 0-100
  inputPath   String?                       // Path to input file
  outputPath  String?                       // Path to output file(s)
  metadata    String?                       // JSON string for extra data
  error       String?                       // Error message if failed
  cost        Int       @default(1)         // Credits charged
  
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  finishedAt  DateTime?
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// STRIPE INTEGRATION (Idempotency)
// ============================================

// Track processed Stripe events to prevent duplicate processing
model StripeEvent {
  id              String    @id @default(cuid())
  stripeEventId   String    @unique  // Stripe event ID (evt_xxx)
  stripeSessionId String?   @unique  // Checkout session ID (cs_xxx) for checkout events
  eventType       String              // e.g., "checkout.session.completed"
  status          String    @default("processed")  // processed | failed | pending
  userId          String?             // Associated user (if applicable)
  creditsAdded    Int?                // Credits added (for purchase events)
  amountPaid      Int?                // Amount in cents (for audit)
  metadata        String?             // JSON string for event data
  error           String?             // Error message if processing failed
  
  processedAt     DateTime  @default(now())
  createdAt       DateTime  @default(now())

  @@index([stripeEventId])
  @@index([stripeSessionId])
  @@index([eventType])
  @@index([processedAt])
}

// ============================================
// REFUND SYSTEM
// ============================================

// Refund request for failed jobs or disputed transactions
model RefundRequest {
  id                  String    @id @default(cuid())
  userId              String
  jobId               String?               // Job that failed (if applicable)
  transactionId       String?               // Original CreditTransaction to refund
  amount              Int                   // Credits to refund
  reason              String                // User-provided or system reason
  status              String    @default("PENDING")  // PENDING | APPROVED | REJECTED | AUTO_APPROVED
  failureStage        String?               // PRE_PROCESS | DURING_PROCESS | POST_PROCESS
  autoRefund          Boolean   @default(false)  // Was this auto-refunded?
  adminNotes          String?               // Notes from admin review
  processedAt         DateTime?             // When the refund was processed
  processedBy         String?               // Admin who processed (or "SYSTEM" for auto)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([jobId])
  @@index([createdAt])
}

// Track users with insufficient balance for Stripe-initiated refunds
model RefundRecovery {
  id                String    @id @default(cuid())
  userId            String
  stripeEventId     String?               // Stripe refund event
  creditsOwed       Int                   // Credits that need to be recovered
  originalAmount    Int                   // Original credits from purchase
  status            String    @default("PENDING")  // PENDING | RECOVERED | WRITTEN_OFF
  notes             String?               // Admin notes
  createdAt         DateTime  @default(now())
  resolvedAt        DateTime?
  resolvedBy        String?               // Admin who resolved

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}
