# Office Converter Dockerfile Extension\n# Add this to your existing Dockerfile for LibreOffice support\n\n# =====================================\n# PRODUCTION STAGE - with LibreOffice\n# =====================================\nFROM python:3.11-slim as production\n\n# Install system dependencies including LibreOffice\nRUN apt-get update && apt-get install -y \\\n    # LibreOffice packages\n    libreoffice-common \\\n    libreoffice-writer \\\n    libreoffice-calc \\\n    libreoffice-impress \\\n    libreoffice-core \\\n    libreoffice-style-colibre \\\n    # Additional utilities\n    curl \\\n    wget \\\n    unzip \\\n    # Security scanning\n    clamav \\\n    clamav-daemon \\\n    # File type detection\n    libmagic1 \\\n    file \\\n    # Process monitoring\n    htop \\\n    # Cleanup\n    && apt-get clean \\\n    && rm -rf /var/lib/apt/lists/* \\\n    && rm -rf /tmp/* \\\n    && rm -rf /var/tmp/*\n\n# Create app user for security\nRUN groupadd -r appuser && useradd -r -g appuser appuser\n\n# Set working directory\nWORKDIR /app\n\n# Copy requirements and install Python dependencies\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\n# Copy application code\nCOPY app/ ./app/\nCOPY scripts/ ./scripts/\nCOPY config/ ./config/\n\n# Create necessary directories with proper permissions\nRUN mkdir -p /app/uploads /app/temp /app/logs /tmp/libreoffice \\\n    && chown -R appuser:appuser /app \\\n    && chown -R appuser:appuser /tmp/libreoffice \\\n    && chmod 755 /app/scripts/*.py\n\n# Set LibreOffice user profile directory\nENV LIBREOFFICE_USER_PROFILE=/tmp/libreoffice\n\n# Configure LibreOffice for headless operation\nRUN mkdir -p /etc/libreoffice \\\n    && echo \"export SAL_USE_VCLPLUGIN=svp\" >> /etc/environment \\\n    && echo \"export DISPLAY=\" >> /etc/environment\n\n# Security: limit resources for LibreOffice processes\nRUN echo \"appuser soft nofile 1024\" >> /etc/security/limits.conf \\\n    && echo \"appuser hard nofile 2048\" >> /etc/security/limits.conf \\\n    && echo \"appuser soft nproc 50\" >> /etc/security/limits.conf \\\n    && echo \"appuser hard nproc 100\" >> /etc/security/limits.conf\n\n# Switch to non-root user\nUSER appuser\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\\n    CMD python -c \"from app.converters.office import OfficeConverter; c = OfficeConverter(); print('✅' if c.check_libreoffice_available() else '❌')\"\n\n# Expose port\nEXPOSE 8000\n\n# Default command\nCMD [\"python\", \"-m\", \"uvicorn\", \"app.main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]\n\n# =====================================\n# WORKER STAGE - Celery with LibreOffice\n# =====================================\nFROM production as worker\n\n# Additional worker-specific configurations\nENV CELERY_WORKER_CONCURRENCY=2\nENV CELERY_WORKER_MAX_TASKS_PER_CHILD=100\nENV CELERY_WORKER_PREFETCH_MULTIPLIER=1\n\n# Resource limits for office conversions\nENV OFFICE_CONVERSION_TIMEOUT=300\nENV OFFICE_MAX_FILE_SIZE=104857600\nENV OFFICE_MAX_MEMORY_MB=2048\n\n# LibreOffice specific environment\nENV SAL_USE_VCLPLUGIN=svp\nENV DISPLAY=\nENV LIBREOFFICE_HEADLESS=1\n\n# Worker command\nCMD [\"python\", \"-m\", \"celery\", \"worker\", \"-A\", \"app.tasks\", \"--loglevel=info\", \"--concurrency=2\"]\n