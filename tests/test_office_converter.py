#!/usr/bin/env python3\n\"\"\"\nOffice Converter Testing Suite\nComprehensive tests for all office conversion functionality\nMPP-XML Converter Pro - Enterprise Edition\n\"\"\"\n\nimport os\nimport sys\nimport tempfile\nimport shutil\nfrom pathlib import Path\nimport time\nimport logging\nimport json\nfrom typing import Dict, List\n\n# Add app to path for imports\nsys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))\n\nfrom app.converters.office import OfficeConverter, SUPPORTED_FORMATS\nfrom app.security.office_security import OfficeSecurity, secure_office_conversion\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\nlog = logging.getLogger(\"office.tests\")\n\nclass OfficeConverterTests:\n    \"\"\"Test suite for Office Converter\"\"\"\n    \n    def __init__(self):\n        self.test_results = []\n        self.temp_dir = tempfile.mkdtemp(prefix='office_tests_')\n        self.converter = OfficeConverter(self.temp_dir)\n        self.security = OfficeSecurity()\n        \n    def create_test_file(self, filename: str, content: str = \"Test document content\") -> str:\n        \"\"\"Create a simple test file\"\"\"\n        file_path = os.path.join(self.temp_dir, filename)\n        \n        if filename.endswith('.csv'):\n            with open(file_path, 'w') as f:\n                f.write(\"Name,Age,City\\nJohn,25,NYC\\nJane,30,LA\\nBob,35,Chicago\")\n        elif filename.endswith('.txt'):\n            with open(file_path, 'w') as f:\n                f.write(content)\n        else:\n            # For binary formats, create a simple text file as placeholder\n            with open(file_path, 'w') as f:\n                f.write(f\"# Test file: {filename}\\n{content}\")\n        \n        return file_path\n    \n    def run_test(self, test_name: str, test_func, *args, **kwargs) -> Dict:\n        \"\"\"Run a single test and record results\"\"\"\n        result = {\n            'name': test_name,\n            'success': False,\n            'duration': 0,\n            'error': None,\n            'details': {}\n        }\n        \n        log.info(f\"ðŸ§ª Running test: {test_name}\")\n        start_time = time.time()\n        \n        try:\n            test_result = test_func(*args, **kwargs)\n            result['success'] = True\n            result['details'] = test_result\n            log.info(f\"âœ… {test_name} - PASSED\")\n        except Exception as e:\n            result['error'] = str(e)\n            log.error(f\"âŒ {test_name} - FAILED: {e}\")\n        \n        result['duration'] = time.time() - start_time\n        self.test_results.append(result)\n        return result\n    \n    def test_libreoffice_availability(self) -> Dict:\n        \"\"\"Test if LibreOffice is available\"\"\"\n        available = self.converter.check_libreoffice_available()\n        return {\n            'libreoffice_available': available,\n            'message': 'LibreOffice is ready' if available else 'LibreOffice not found'\n        }\n    \n    def test_supported_formats(self) -> Dict:\n        \"\"\"Test supported format validation\"\"\"\n        conversions = self.converter.get_supported_conversions()\n        \n        return {\n            'total_conversions': len(conversions),\n            'input_formats': list(SUPPORTED_FORMATS['input']),\n            'output_formats': list(SUPPORTED_FORMATS['output']),\n            'sample_conversions': conversions[:5]\n        }\n    \n    def test_format_validation(self) -> Dict:\n        \"\"\"Test file format validation\"\"\"\n        test_cases = [\n            ('document.docx', True),\n            ('spreadsheet.xlsx', True),\n            ('presentation.pptx', True),\n            ('malicious.exe', False),\n            ('unknown.xyz', False),\n            ('data.csv', True)\n        ]\n        \n        results = []\n        for filename, expected in test_cases:\n            try:\n                input_ext = Path(filename).suffix.lstrip('.')\n                self.converter.validate_conversion(input_ext, 'pdf')\n                actual = True\n            except:\n                actual = False\n            \n            results.append({\n                'filename': filename,\n                'expected': expected,\n                'actual': actual,\n                'passed': expected == actual\n            })\n        \n        return {\n            'test_cases': results,\n            'passed': all(r['passed'] for r in results)\n        }\n    \n    def test_conversion_pricing(self) -> Dict:\n        \"\"\"Test conversion pricing calculation\"\"\"\n        test_conversions = [\n            ('docx', 'pdf'),\n            ('xlsx', 'csv'),\n            ('pptx', 'pdf'),\n            ('doc', 'docx')\n        ]\n        \n        pricing_results = []\n        for input_fmt, output_fmt in test_conversions:\n            try:\n                conversion_info = self.converter.validate_conversion(input_fmt, output_fmt)\n                pricing_results.append({\n                    'conversion': f\"{input_fmt} â†’ {output_fmt}\",\n                    'price': conversion_info['price'],\n                    'complexity': conversion_info['complexity']\n                })\n            except Exception as e:\n                pricing_results.append({\n                    'conversion': f\"{input_fmt} â†’ {output_fmt}\",\n                    'error': str(e)\n                })\n        \n        return {\n            'pricing_tests': pricing_results,\n            'average_price': sum(r.get('price', 0) for r in pricing_results) / len(pricing_results)\n        }\n    \n    def test_security_validation(self) -> Dict:\n        \"\"\"Test security validation features\"\"\"\n        # Create test files\n        test_files = [\n            ('clean_document.docx', 'Clean test document'),\n            ('suspicious_file.exe', 'MZ'),  # Executable header\n            ('large_file.xlsx', 'X' * 1000),  # Normal size\n        ]\n        \n        security_results = []\n        for filename, content in test_files:\n            file_path = self.create_test_file(filename, content)\n            \n            try:\n                validation = self.security.validate_file_structure(file_path)\n                security_results.append({\n                    'filename': filename,\n                    'valid': validation['valid'],\n                    'risk_score': validation['risk_score'],\n                    'issues': validation['security_issues']\n                })\n            except Exception as e:\n                security_results.append({\n                    'filename': filename,\n                    'error': str(e)\n                })\n        \n        return {\n            'security_tests': security_results,\n            'clamav_available': self.security._is_clamav_available()\n        }\n    \n    def test_sandbox_creation(self) -> Dict:\n        \"\"\"Test sandbox environment creation\"\"\"\n        sandbox_path = self.security.create_sandbox()\n        \n        sandbox_exists = os.path.exists(sandbox_path)\n        subdirs_exist = all(\n            os.path.exists(os.path.join(sandbox_path, subdir))\n            for subdir in ['input', 'output', 'temp', 'logs']\n        )\n        \n        # Cleanup\n        self.security.cleanup_sandbox(sandbox_path)\n        \n        return {\n            'sandbox_path': sandbox_path,\n            'sandbox_created': sandbox_exists,\n            'subdirs_created': subdirs_exist,\n            'cleanup_successful': not os.path.exists(sandbox_path)\n        }\n    \n    def test_mock_conversion(self) -> Dict:\n        \"\"\"Test mock conversion workflow (without LibreOffice)\"\"\"\n        # Create test input file\n        input_file = self.create_test_file('test_doc.csv')\n        output_dir = os.path.join(self.temp_dir, 'output')\n        os.makedirs(output_dir, exist_ok=True)\n        \n        # Mock conversion by just copying the file with new extension\n        try:\n            output_path = os.path.join(output_dir, 'test_doc.xlsx')\n            shutil.copy2(input_file, output_path)\n            \n            conversion_result = {\n                'success': True,\n                'input_file': input_file,\n                'output_file': output_path,\n                'input_format': 'csv',\n                'output_format': 'xlsx',\n                'file_size': os.path.getsize(output_path),\n                'conversion_time': time.time()\n            }\n            \n            return conversion_result\n            \n        except Exception as e:\n            return {\n                'success': False,\n                'error': str(e)\n            }\n    \n    def test_converter_stats(self) -> Dict:\n        \"\"\"Test converter statistics tracking\"\"\"\n        initial_stats = self.converter.get_stats()\n        \n        # Simulate some conversions\n        self.converter.stats['conversions_total'] = 10\n        self.converter.stats['conversions_success'] = 8\n        self.converter.stats['conversions_failed'] = 2\n        self.converter.stats['total_processing_time'] = 45.5\n        \n        final_stats = self.converter.get_stats()\n        \n        return {\n            'initial_stats': initial_stats,\n            'final_stats': final_stats,\n            'stats_working': 'success_rate' in final_stats\n        }\n    \n    def test_api_endpoints_structure(self) -> Dict:\n        \"\"\"Test if API router structure is correct\"\"\"\n        try:\n            from app.routers.office import router\n            \n            # Check if router has expected routes\n            routes = [route.path for route in router.routes]\n            expected_routes = [\n                '/convert/office/formats',\n                '/convert/office/quote', \n                '/convert/office',\n                '/convert/office/status/{order_id}',\n                '/convert/office/batch',\n                '/convert/office/health'\n            ]\n            \n            route_coverage = {\n                route: any(expected in route for expected in expected_routes)\n                for route in routes\n            }\n            \n            return {\n                'router_loaded': True,\n                'routes_found': routes,\n                'route_coverage': route_coverage,\n                'all_routes_present': len(routes) >= len(expected_routes)\n            }\n            \n        except Exception as e:\n            return {\n                'router_loaded': False,\n                'error': str(e)\n            }\n    \n    def run_all_tests(self) -> Dict:\n        \"\"\"Run complete test suite\"\"\"\n        log.info(\"ðŸš€ Starting Office Converter Test Suite\")\n        \n        # Run all tests\n        tests = [\n            ('LibreOffice Availability', self.test_libreoffice_availability),\n            ('Supported Formats', self.test_supported_formats),\n            ('Format Validation', self.test_format_validation),\n            ('Conversion Pricing', self.test_conversion_pricing),\n            ('Security Validation', self.test_security_validation),\n            ('Sandbox Creation', self.test_sandbox_creation),\n            ('Mock Conversion', self.test_mock_conversion),\n            ('Converter Stats', self.test_converter_stats),\n            ('API Router Structure', self.test_api_endpoints_structure)\n        ]\n        \n        for test_name, test_func in tests:\n            self.run_test(test_name, test_func)\n        \n        # Generate summary\n        passed_tests = [r for r in self.test_results if r['success']]\n        failed_tests = [r for r in self.test_results if not r['success']]\n        total_duration = sum(r['duration'] for r in self.test_results)\n        \n        summary = {\n            'total_tests': len(self.test_results),\n            'passed': len(passed_tests),\n            'failed': len(failed_tests),\n            'success_rate': len(passed_tests) / len(self.test_results) * 100,\n            'total_duration': total_duration,\n            'test_results': self.test_results\n        }\n        \n        # Print summary\n        self.print_test_summary(summary)\n        \n        return summary\n    \n    def print_test_summary(self, summary: Dict):\n        \"\"\"Print formatted test summary\"\"\"\n        print(\"\\n\" + \"=\" * 80)\n        print(\"ðŸ“‹ OFFICE CONVERTER TEST RESULTS\")\n        print(\"=\" * 80)\n        \n        print(f\"\\nðŸ“Š SUMMARY:\")\n        print(f\"   Total Tests: {summary['total_tests']}\")\n        print(f\"   âœ… Passed: {summary['passed']}\")\n        print(f\"   âŒ Failed: {summary['failed']}\")\n        print(f\"   ðŸŽ¯ Success Rate: {summary['success_rate']:.1f}%\")\n        print(f\"   â±ï¸  Total Duration: {summary['total_duration']:.2f}s\")\n        \n        # Failed tests details\n        if summary['failed'] > 0:\n            print(f\"\\nâŒ FAILED TESTS:\")\n            for result in summary['test_results']:\n                if not result['success']:\n                    print(f\"   â€¢ {result['name']}: {result['error']}\")\n        \n        # Success details\n        if summary['passed'] > 0:\n            print(f\"\\nâœ… PASSED TESTS:\")\n            for result in summary['test_results']:\n                if result['success']:\n                    print(f\"   â€¢ {result['name']} ({result['duration']:.2f}s)\")\n        \n        # Overall status\n        if summary['success_rate'] >= 80:\n            print(f\"\\nðŸŽ‰ OVERALL STATUS: EXCELLENT - Office Converter Ready for Production!\")\n        elif summary['success_rate'] >= 60:\n            print(f\"\\nðŸŸ¡ OVERALL STATUS: GOOD - Minor issues to address\")\n        else:\n            print(f\"\\nðŸ”´ OVERALL STATUS: NEEDS ATTENTION - Major issues detected\")\n        \n        print(\"=\" * 80)\n    \n    def cleanup(self):\n        \"\"\"Cleanup test environment\"\"\"\n        try:\n            shutil.rmtree(self.temp_dir)\n            log.info(f\"Test environment cleaned up: {self.temp_dir}\")\n        except Exception as e:\n            log.warning(f\"Cleanup failed: {e}\")\n\ndef main():\n    \"\"\"Run the complete test suite\"\"\"\n    tester = OfficeConverterTests()\n    \n    try:\n        results = tester.run_all_tests()\n        \n        # Save results to file\n        results_file = 'office_converter_test_results.json'\n        with open(results_file, 'w') as f:\n            json.dump(results, f, indent=2, default=str)\n        print(f\"\\nðŸ“„ Test results saved to: {results_file}\")\n        \n        # Exit with appropriate code\n        exit_code = 0 if results['success_rate'] >= 80 else 1\n        return exit_code\n        \n    except Exception as e:\n        log.exception(\"Test suite failed\")\n        return 1\n    \n    finally:\n        tester.cleanup()\n\nif __name__ == \"__main__\":\n    exit_code = main()\n    sys.exit(exit_code)\n