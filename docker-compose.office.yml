# =====================================\n# DOCKER COMPOSE - Office Converter\n# Production configuration with LibreOffice\n# =====================================\n\nversion: '3.8'\n\nservices:\n  # =====================================\n  # WEB APPLICATION\n  # =====================================\n  web:\n    build: \n      context: .\n      dockerfile: Dockerfile.office\n      target: production\n    ports:\n      - \"8000:8000\"\n    environment:\n      - NODE_ENV=production\n      - CELERY_BROKER_URL=redis://redis:6379/0\n      - CELERY_RESULT_BACKEND=redis://redis:6379/0\n      - DATABASE_URL=postgresql://user:password@postgres:5432/converter_db\n    volumes:\n      - ./uploads:/app/uploads\n      - ./logs:/app/logs\n      - /tmp:/tmp\n    depends_on:\n      - redis\n      - postgres\n    deploy:\n      resources:\n        limits:\n          cpus: '1.0'\n          memory: 1G\n        reservations:\n          cpus: '0.5'\n          memory: 512M\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n  # =====================================\n  # CELERY WORKER - Office Conversions\n  # =====================================\n  worker:\n    build:\n      context: .\n      dockerfile: Dockerfile.office\n      target: worker\n    environment:\n      - CELERY_BROKER_URL=redis://redis:6379/0\n      - CELERY_RESULT_BACKEND=redis://redis:6379/0\n      - CELERY_WORKER_CONCURRENCY=2\n      - CELERY_WORKER_MAX_TASKS_PER_CHILD=50\n      - OFFICE_CONVERSION_TIMEOUT=300\n      - OFFICE_MAX_FILE_SIZE=104857600\n      - SAL_USE_VCLPLUGIN=svp\n      - DISPLAY=\n      - LIBREOFFICE_HEADLESS=1\n    volumes:\n      - ./uploads:/app/uploads\n      - ./temp:/app/temp\n      - ./logs:/app/logs\n      - /tmp:/tmp\n    depends_on:\n      - redis\n      - postgres\n    deploy:\n      resources:\n        limits:\n          cpus: '2.0'\n          memory: 4G\n        reservations:\n          cpus: '1.0'\n          memory: 2G\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n  # =====================================\n  # CELERY MONITOR\n  # =====================================\n  flower:\n    image: mher/flower:0.9.7\n    environment:\n      - CELERY_BROKER_URL=redis://redis:6379/0\n      - FLOWER_PORT=5555\n    ports:\n      - \"5555:5555\"\n    depends_on:\n      - redis\n    networks:\n      - converter-network\n\n  # =====================================\n  # REDIS CACHE & BROKER\n  # =====================================\n  redis:\n    image: redis:7-alpine\n    ports:\n      - \"6379:6379\"\n    volumes:\n      - redis_data:/data\n    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru\n    deploy:\n      resources:\n        limits:\n          cpus: '0.5'\n          memory: 512M\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n  # =====================================\n  # POSTGRESQL DATABASE\n  # =====================================\n  postgres:\n    image: postgres:15-alpine\n    environment:\n      - POSTGRES_DB=converter_db\n      - POSTGRES_USER=converter_user\n      - POSTGRES_PASSWORD=secure_password_2025\n      - PGDATA=/var/lib/postgresql/data/pgdata\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql\n    ports:\n      - \"5432:5432\"\n    deploy:\n      resources:\n        limits:\n          cpus: '1.0'\n          memory: 1G\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n  # =====================================\n  # NGINX REVERSE PROXY\n  # =====================================\n  nginx:\n    image: nginx:alpine\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./config/nginx.conf:/etc/nginx/nginx.conf\n      - ./ssl:/etc/nginx/ssl\n      - ./logs/nginx:/var/log/nginx\n    depends_on:\n      - web\n    deploy:\n      resources:\n        limits:\n          cpus: '0.5'\n          memory: 256M\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n  # =====================================\n  # MONITORING - PROMETHEUS\n  # =====================================\n  prometheus:\n    image: prom/prometheus:latest\n    ports:\n      - \"9090:9090\"\n    volumes:\n      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml\n      - prometheus_data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n      - '--storage.tsdb.path=/prometheus'\n      - '--web.console.libraries=/etc/prometheus/console_libraries'\n      - '--web.console.templates=/etc/prometheus/consoles'\n      - '--storage.tsdb.retention.time=30d'\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n  # =====================================\n  # MONITORING - GRAFANA\n  # =====================================\n  grafana:\n    image: grafana/grafana:latest\n    ports:\n      - \"3001:3000\"\n    environment:\n      - GF_SECURITY_ADMIN_PASSWORD=admin_2025_secure\n    volumes:\n      - grafana_data:/var/lib/grafana\n      - ./config/grafana:/etc/grafana/provisioning\n    restart: unless-stopped\n    networks:\n      - converter-network\n\n# =====================================\n# VOLUMES\n# =====================================\nvolumes:\n  postgres_data:\n    driver: local\n  redis_data:\n    driver: local\n  prometheus_data:\n    driver: local\n  grafana_data:\n    driver: local\n\n# =====================================\n# NETWORKS\n# =====================================\nnetworks:\n  converter-network:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 172.20.0.0/16\n