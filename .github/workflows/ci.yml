name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20.x'

jobs:
  # ===============================
  # LINT & TYPE CHECK
  # ===============================
  lint:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run syntax check
        run: npm run syntax:check || node scripts/syntax-check.js

  # ===============================
  # UNIT TESTS
  # ===============================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test || echo "Tests need to be configured"
      
      - name: Run converter audit
        run: npm run audit:converters

  # ===============================
  # SMOKE TEST
  # ===============================
  smoke:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env file
        run: |
          echo "PORT=3000" > .env
          echo "NODE_ENV=test" >> .env
      
      - name: Start server
        run: |
          node api/server.js &
          sleep 5
      
      - name: Run smoke tests
        run: |
          # Health check
          curl -f http://localhost:3000/health || exit 1
          
          # API V1 converters
          CONVERTERS=$(curl -s http://localhost:3000/api/v1/converters | jq '.count')
          if [ "$CONVERTERS" -lt 5 ]; then
            echo "Error: Only $CONVERTERS converters found, minimum is 5"
            exit 1
          fi
          echo "âœ“ Found $CONVERTERS converters"
          
          # Main page
          curl -f http://localhost:3000/ || exit 1
          
          echo "âœ“ All smoke tests passed"

  # ===============================
  # SECURITY SCAN
  # ===============================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=high || true
      
      - name: Check for secrets
        run: |
          # Check for common secret patterns
          if grep -rE "(password|secret|api_key|apikey|token).*=.*['\"][^'\"]+['\"]" --include="*.js" --include="*.json" . 2>/dev/null | grep -v node_modules | grep -v ".env"; then
            echo "Warning: Possible secrets found in code"
          fi

  # ===============================
  # BUILD DOCKER IMAGE
  # ===============================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, smoke]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: false
          tags: cannaconverter:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===============================
  # DEPLOY (only on main)
  # ===============================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy notification
        run: |
          echo "ðŸš€ Ready to deploy commit ${{ github.sha }}"
          echo "Add your deployment steps here (e.g., SSH to server, Docker push, etc.)"
